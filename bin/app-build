#!/bin/bash

green="\033[0;32m"
nc="\033[0m"

link_runtime() {
  local dest="/root/app/node_modules/babel-runtime"
  if [ ! -e "$dest" ]; then
    mkdir -p /root/app/node_modules && \
    ln -s /root/share/node_modules/babel-runtime "$dest"
  fi
}

compile() {
  # ln -s /root/share/node_modules /node_modules && \
  NODE_PATH=/root/share/node_modules \
  babel /app                         \
  --presets node6,flow,stage-$STAGE  \
  --ignore node_modules              \
  --copy-files                       \
  -d /root/app                       \
  >/dev/null
}

link_packages() {
  local src="/app/node_modules"
  local dest="/root/app/node_modules"
  mkdir -p $src
  if [ ! -e "$dest" ]; then
    ln -s "$src" "$dest"
  fi
}

install_packages() {
  cd /root/app;
  #rm -rf ./node_modules;
  # also installs devDependencies for the sake of testing before launching app
  #npm install --production=false --loglevel error > /dev/null
}

echo -n "Building app... " && \
compile                    && \
link_packages              && \
echo -e "$green\u2713$nc"
